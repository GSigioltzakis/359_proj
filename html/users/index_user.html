<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>User Dashboard</title>
    <!--calendar parmeno apo: https://fullcalendar.io/-->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <link rel="stylesheet" href="../../css/index2.css" />
    <link rel="icon" type="image/x-icon" href="../music_note.png">

</head>

<body>
    <header class="top-nav">
        <div class="nav-left">
            <a href="../../index.html" class="brand" style="text-decoration:none;">Explore</a>

            <button id="sortBtn" class="account-btn" type="button">Î¤Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ· â–¾</button>
            <button id="filtersBtn" class="account-btn" type="button">Î¦Î¯Î»Ï„ÏÎ± â–¾</button>

            <div class="account">
                <button id="accountBtn" class="account-btn" type="button">Account â–¾</button>
                <div id="accountMenu" class="account-menu">
                    <a href="/html/users/my_tickets.html">My tickets</a>
                    <div class="menu-sep"></div>
                    <a href="#" id="logoutBtn">Log out</a>
                </div>
            </div>

        </div>
    </header>

    <main class="page">
        <!-- Î‘Î¡Î™Î£Î¤Î•Î¡Î‘: CALENDAR and RESULTS -->
        <section class="left-col">
            <div class="calendar-card">
                <h3 class="panel-title">Public Events</h3>
                <div id="calendar"></div>
            </div>

            <div class="results-card">
                <h3 class="panel-title">Results</h3>
                <div id="resultsList">Loading...</div>
            </div>
            <div class="map-card">

                <div id="map"></div>

                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@7.5.2/ol.css">
                <script src="https://cdn.jsdelivr.net/npm/ol@7.5.2/dist/ol.js"></script>
            </div>

        </section>

        <!-- Î”Î•ÎÎ™Î‘: BAND CARDS -->
        <aside class="right-col">
            <div class="band-filters-card">
                <h3 style="margin:0 0 10px 0;">Band Filters</h3>

                <div class="bf-row">
                    <label class="bf">
                        <span>Î ÏŒÎ»Î·</span>
                        <input id="bandCity" list="greekCities" placeholder="Ï€.Ï‡. Î§Î±Î½Î¹Î¬" />
                    </label>

                    <label class="bf">
                        <span>ÎˆÏ„Î¿Ï‚ Î±Ï€ÏŒ</span>
                        <input id="bandYearFrom" type="number" min="1900" max="2100" placeholder="Ï€.Ï‡. 2010" />
                    </label>

                    <label class="bf">
                        <span>ÎˆÏ„Î¿Ï‚ Î­Ï‰Ï‚</span>
                        <input id="bandYearTo" type="number" min="1900" max="2100" placeholder="Ï€.Ï‡. 2020" />
                    </label>
                </div>

                <!-- Genres multi-select (checkbox dropdown) -->
                <div class="bf">
                    <span>Î•Î¯Î´Î·</span>
                    <div class="multi-select" id="bandGenreMulti">
                        <button type="button" class="multi-btn" id="bandGenreBtn">
                            <span id="bandGenreBtnText">ÎŒÎ»Î± Ï„Î± ÎµÎ¯Î´Î·</span><span class="caret">â–¾</span>
                        </button>
                        <div class="multi-menu" id="bandGenreMenu">
                            <label class="multi-item"><input type="checkbox" value="traditional">
                                <span>Î Î±ÏÎ±Î´Î¿ÏƒÎ¹Î±ÎºÎ¬</span></label>
                            <label class="multi-item"><input type="checkbox" value="laiko"> <span>Î›Î±ÏŠÎºÏŒ</span></label>
                            <label class="multi-item"><input type="checkbox" value="entexno">
                                <span>ÎˆÎ½Ï„ÎµÏ‡Î½Î¿</span></label>
                            <label class="multi-item"><input type="checkbox" value="rock"> <span>Rock</span></label>
                            <label class="multi-item"><input type="checkbox" value="pop"> <span>Pop</span></label>
                            <label class="multi-item"><input type="checkbox" value="jazz"> <span>Jazz</span></label>

                            <div class="multi-actions">
                                <button type="button" class="mini-btn" id="bandGenresClear">Clear</button>
                                <button type="button" class="mini-btn primary" id="bandGenresDone">Done</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bf-actions">
                    <button id="bandApply" class="primary-btn" type="button">Apply</button>
                    <button id="bandClear" class="ghost-btn" type="button">Clear</button>
                </div>
            </div>

            <h3 class="panel-title">Bands</h3>
            <div id="bandsGrid" class="bands-grid">Loading...</div>
        </aside>
    </main>

    <!-- SORT MENU (dropdown) -->
    <div id="sortMenu" class="dropdown">
        <button class="drop-item" data-sort="price_asc">Î¤Î¹Î¼Î®: Î§Î±Î¼Î·Î»Î® Ï€ÏÏÏ„Î±</button>
        <button class="drop-item" data-sort="price_desc">Î¤Î¹Î¼Î®: Î¥ÏˆÎ·Î»Î® Ï€ÏÏÏ„Î±</button>
        <button class="drop-item" data-sort="date_asc">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± (Ï€Î¹Î¿ ÏƒÏÎ½Ï„Î¿Î¼Î±)</button>
        <button class="drop-item" data-sort="date_desc">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± (Ï€Î¹Î¿ Î±ÏÎ³Î¬)</button>
        <button class="drop-item" data-sort="distance">Î‘Ï€ÏŒÏƒÏ„Î±ÏƒÎ· (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)</button>
    </div>

    <!-- FILTERS PANEL -->
    <div id="filtersPanel" class="drawer">
        <div class="drawer-header">
            <div class="drawer-title">Filters</div>
            <button id="closeFilters" class="icon-btn" type="button">âœ•</button>
        </div>

        <div class="drawer-body">
            <!-- Ï†Î¹Î»Ï„ÏÎ±  -->
            <label class="f">
                <span>Î ÏŒÎ»Î·</span>
                <input id="cityInput" placeholder="Ï€.Ï‡. Î‘Î¸Î®Î½Î±" />
            </label>

            <label class="f">
                <span>Î‘Ï€ÏŒ</span>
                <input id="dateFrom" type="date" />
            </label>

            <label class="f">
                <span>ÎˆÏ‰Ï‚</span>
                <input id="dateTo" type="date" />
            </label>

            <label class="f">
                <span>Max â‚¬</span>
                <input id="maxPrice" type="number" min="0" step="1" placeholder="Ï€.Ï‡. 50" />
            </label>

            <label class="f">
                <span>Search</span>
                <input id="textSearch" placeholder="title/description" />
            </label>

            <!-- Genres multi-select-->
            <div class="f">
                <span>Î•Î¯Î´Î·</span>
                <div class="multi-select" id="genreMulti">
                    <button type="button" class="multi-btn" id="genreBtn">
                        <span id="genreBtnText">ÎŒÎ»Î± Ï„Î± ÎµÎ¯Î´Î·</span><span class="caret">â–¾</span>
                    </button>
                    <div class="multi-menu" id="genreMenu">
                        <label class="multi-item"><input type="checkbox" value="rock"> <span>Rock</span></label>
                        <label class="multi-item"><input type="checkbox" value="pop"> <span>Pop</span></label>
                        <label class="multi-item"><input type="checkbox" value="laiko"> <span>Î›Î±ÏŠÎºÏŒ</span></label>
                        <label class="multi-item"><input type="checkbox" value="entexno"> <span>ÎˆÎ½Ï„ÎµÏ‡Î½Î¿</span></label>
                        <div class="multi-actions">
                            <button type="button" class="mini-btn" id="genresClear">Clear</button>
                            <button type="button" class="mini-btn primary" id="genresDone">Done</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="drawer-actions">
                <button id="applyBtn" class="primary-btn" type="button">Apply</button>
                <button id="clearBtn" class="ghost-btn" type="button">Clear</button>
            </div>
        </div>
    </div>

    <!-- overlay Î³Î¹Î± drawer -->
    <div id="overlay" class="overlay"></div>

    <footer class="site-footer" id="siteFooter">
        <button class="footer-toggle" id="footerToggle" type="button" aria-expanded="false">
            Extra info & links â–¾
        </button>

        <div class="footer-content" id="footerContent">
            <div class="footer-col">
                <div class="footer-title">Î ÏÏŒÎ²Î»ÎµÏˆÎ·/Î Î±ÏÎ±ÎºÎ¿Î»Î¿ÏÎ¸Î·ÏƒÎ· Î Ï…ÏÎºÎ±Î³Î¹ÏÎ½</div>
                <a class="footer-link" href="https://civilprotection.gov.gr/en/xartis" target="_blank"
                    rel="noopener noreferrer">
                    Î§Î¬ÏÏ„Î·Ï‚ Î ÏÏŒÎ²Î»ÎµÏˆÎ·Ï‚ ÎšÎ¹Î½Î´ÏÎ½Î¿Ï… Î Ï…ÏÎºÎ±Î³Î¹Î¬Ï‚ (Î Î¿Î»Î¹Ï„Î¹ÎºÎ® Î ÏÎ¿ÏƒÏ„Î±ÏƒÎ¯Î±)
                </a>
                <a class="footer-link" href="https://forest-fire.emergency.copernicus.eu/apps/effis_current_situation/"
                    target="_blank" rel="noopener noreferrer">
                    Copernicus EFFIS â€“ Current situation / fire danger
                </a>
                <a class="footer-link" href="https://firms.modaps.eosdis.nasa.gov/map/" target="_blank"
                    rel="noopener noreferrer">
                    NASA FIRMS â€“ Active fires map (near real-time)
                </a>
                <a class="footer-link" href="https://www.windy.com/-Fire-spread-fwi" target="_blank"
                    rel="noopener noreferrer">
                    Windy â€“ Fire spread / fire danger layer
                </a>
            </div>

            <div class="footer-col">
                <div class="footer-title">Î Î±ÏÏŒÎ¼Î¿Î¹Î± sites (ÎµÎºÎ´Î·Î»ÏÏƒÎµÎ¹Ï‚/Î¼Î¿Ï…ÏƒÎ¹ÎºÎ®)</div>
                <a class="footer-link" href="https://www.more.com/gr-en/tickets/music/" target="_blank"
                    rel="noopener noreferrer">
                    more.com â€“ Music tickets (GR)
                </a>
                <a class="footer-link" href="https://www.songkick.com/metro-areas/28976-greece-athens" target="_blank"
                    rel="noopener noreferrer">
                    Songkick â€“ Concerts in Athens
                </a>
                <a class="footer-link" href="https://ra.co/events/gr/all" target="_blank" rel="noopener noreferrer">
                    Resident Advisor â€“ Events in Greece
                </a>
                <a class="footer-link" href="https://www.bandsintown.com/" target="_blank" rel="noopener noreferrer">
                    Bandsintown â€“ Live music discovery
                </a>
                <a class="footer-link" href="https://open.spotify.com/concerts/location/264371-Athens-GR"
                    target="_blank" rel="noopener noreferrer">
                    Spotify Concerts â€“ Athens
                </a>
            </div>
        </div>
    </footer>

    <!-- Floating Music Assistant -->
    <button id="musicFab" class="music-fab" type="button">ğŸ’¬ Î¡ÏÏ„Î± Î³Î¹Î± Î¼Î¿Ï…ÏƒÎ¹ÎºÎ®</button>

    <div id="musicDrawer" class="music-drawer">
        <div class="music-head">
            <div class="music-title">Music Assistant</div>
            <button id="musicClose" class="icon-btn" type="button">âœ•</button>
        </div>

        <div class="music-suggestions">
            <div class="sug-title">Î”Î¿ÎºÎ¯Î¼Î±ÏƒÎµ:</div>
            <button class="sug" data-q="Î¤Î¹ ÎµÎ¯Î½Î±Î¹ Ï„Î¿ blues scale ÎºÎ±Î¹ Ï€ÏÏ‚ Ï„Î¿ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Ï;">Blues scale</button>
            <button class="sug" data-q="Î”ÏÏƒÎµ Î¼Î¿Ï… 4 ÎµÏÎºÎ¿Î»ÎµÏ‚ chord progressions ÏƒÎµ minor.">Chord progressions</button>
            <button class="sug" data-q="Î Î¿Î¹Î± Î· Î´Î¹Î±Ï†Î¿ÏÎ¬ 4/4 ÎºÎ±Î¹ 6/8;">4/4 vs 6/8</button>
            <button class="sug" data-q="Tips Î³Î¹Î± setlist ÏƒÎµ live 45 Î»ÎµÏ€Ï„ÏÎ½;">Setlist tips</button>
        </div>

        <div id="musicMsgs" class="music-msgs"></div>

        <div class="music-input">
            <input id="musicText" placeholder="Î“ÏÎ¬ÏˆÎµ Ï„Î·Î½ ÎµÏÏÏ„Î·ÏƒÎ® ÏƒÎ¿Ï…..." />
            <button id="musicSend" type="button">Send</button>
        </div>
    </div>

    <div id="musicOverlay" class="overlay"></div>

    <!-- ticket card -->
    <!-- Tickets Modal -->
    <div id="ticketOverlay" class="overlay"></div>

    <div id="ticketModal" class="ticket-modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="ticket-head">
            <div>
                <div id="ticketTitle" class="ticket-title">Tickets</div>
                <div id="ticketMeta" class="ticket-meta"></div>
            </div>
            <button id="ticketClose" class="icon-btn" type="button">âœ•</button>
        </div>

        <div class="ticket-body">
            <label class="t-field">
                <span>Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎµÎ¹ÏƒÎ¹Ï„Î·ÏÎ¯Ï‰Î½</span>
                <input id="ticketQty" type="number" min="1" value="1" />
            </label>

            <div class="ticket-summary">
                <div>Î¤Î¹Î¼Î® Î±Î½Î¬ ÎµÎ¹ÏƒÎ¹Ï„Î®ÏÎ¹Î¿: <b>â‚¬<span id="ticketUnit">0</span></b></div>
                <div>Î£ÏÎ½Î¿Î»Î¿: <b>â‚¬<span id="ticketTotal">0</span></b></div>
            </div>

            <div class="ticket-pay">
                <button id="ticketPayBtn" class="btn btn-ticket" type="button">Pay</button>
            </div>

            <div id="ticketMsg" class="ticket-msg"></div>
        </div>
    </div>


    <!-- JavaScript-->
    <script>
        // Sort dropdown
        const sortBtn = document.getElementById('sortBtn');
        const sortMenu = document.getElementById('sortMenu');

        sortBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            sortMenu.classList.toggle('open');
        });

        document.addEventListener('click', () => {
            sortMenu.classList.remove('open');
        });

        // Filters drawer
        const filtersBtn = document.getElementById('filtersBtn');
        const filtersPanel = document.getElementById('filtersPanel');
        const closeFilters = document.getElementById('closeFilters');
        const overlay = document.getElementById('overlay');

        function openFilters() {
            filtersPanel.classList.add('open');
            overlay.classList.add('open');
        }
        function closeFiltersFn() {
            filtersPanel.classList.remove('open');
            overlay.classList.remove('open');
        }

        //Ï„Î±Î¾Î¹Î½Î¿Î¼Î·ÏƒÎ· 
        let activeSort = "date_asc"; // default

        function sortEvents(list) {
            const arr = list.slice();

            switch (activeSort) {
                case "price_asc":
                    return arr.sort((a, b) => (Number(a.price ?? 0) - Number(b.price ?? 0)));

                case "price_desc":
                    return arr.sort((a, b) => (Number(b.price ?? 0) - Number(a.price ?? 0)));

                case "date_desc":
                    return arr.sort((a, b) => (new Date(b.start) - new Date(a.start)));

                case "date_asc":
                default:
                    return arr.sort((a, b) => (new Date(a.start) - new Date(b.start)));
            }
        }


        filtersBtn.addEventListener('click', openFilters);
        closeFilters.addEventListener('click', closeFiltersFn);
        overlay.addEventListener('click', closeFiltersFn);
        document.querySelectorAll('#sortMenu .drop-item').forEach(btn => {
            btn.addEventListener('click', () => {
                activeSort = btn.dataset.sort;
                sortMenu.classList.remove('open');
                applyFilters(); // âœ… Î¾Î±Î½Î±ÎºÎ¬Î½ÎµÎ¹ render Î¼Îµ Ï„Î±Î¾Î¹Î½ÏŒÎ¼Î·ÏƒÎ·
            });
        });


        // render bands gia cards 
        function renderBands(bands) {
            const grid = document.getElementById('bandsGrid');

            if (!bands.length) {
                grid.innerHTML = `<p style="opacity:.8">No bands found.</p>`;
                return;
            }

            grid.innerHTML = bands.map(b => {
                // photo
                const MAX_CUSTOM_IMAGES = 20;
                let imgSrc = 'images/default.jpg';

                // If band ID is between 1 and 20, use that specific image
                if (b.band_id <= MAX_CUSTOM_IMAGES) {
                    imgSrc = `../../images/band_${b.band_id}.jpg`;
                }
                return `
                <div class="band-card" onclick="location.href='http://localhost:3000/html/bands/band_profile.html?id=${b.band_id}'">
                    <img src="${imgSrc}" alt="band">
                    <div class="b">
                    <div class="name">${b.band_name}</div>
                    <div class="meta">${b.band_city || ''} â€¢ ${b.foundedYear || ''}</div>
                    <div class="meta" style="opacity:.85">${b.music_genres || ''}</div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // Account menu toggle
        const account = document.querySelector('.account');
        const accountBtn = document.getElementById('accountBtn');
        // Toggle menu on button click
        accountBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            account.classList.toggle('open');
        });
        // Close menu on outside click

        document.addEventListener('click', () => {
            account.classList.remove('open');
        });
        const API_BASE = 'http://localhost:3000/band';
        let allPublicEvents = []; //gia na krataei ola ta public events gia ta filters
        let currentFilteredEvents = []; //gia na krataei ta filtered events gia to sort

        let calendar; //gia na exoume prosbasi sto calendar apo diafora functions
        function normalize(s) {
            return (s ?? '').toString().trim().toLowerCase();
        }
        function getSelectedGenres() {
            const checkboxes = document.querySelectorAll('#genreMenu input[type="checkbox"]');
            const selected = [];
            checkboxes.forEach(cb => {
                if (cb.checked) selected.push(normalize(cb.value));
            });
            return selected;
        }
        // Aktualopoiisi tou text sto genre button
        function updateGenreButtonText() {
            const selected = getSelectedGenres();
            const textEl = document.getElementById('genreBtnText');
            // An den exei epilexthei tipota
            if (selected.length === 0) {
                textEl.textContent = 'ÎŒÎ»Î± Ï„Î± ÎµÎ¯Î´Î·';
                return;
            }

            // Î‘Î½ ÎµÎ¯Î½Î±Î¹ Î»Î¯Î³Î±, Î´ÎµÎ¯Î¾Ï„Î±. Î‘Î½ ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Î»Î¬, Î´ÎµÎ¯Î¾Îµ count.
            if (selected.length <= 2) {
                textEl.textContent = selected.join(', ');
            } else {
                textEl.textContent = `${selected.length} selected`;
            }
        }
        //open / close tou multi-select menu
        const genreBtn = document.getElementById('genreBtn');
        const genreMenu = document.getElementById('genreMenu');
        genreBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            genreMulti.classList.toggle('open');
        });
        //close to menu otan kanei click ektos
        document.addEventListener('click', () => {
            genreMulti.classList.remove('open');
        });
        // Elements gia to multi-select
        const genreMulti = document.getElementById('genreMulti');
        const genresClear = document.getElementById('genresClear');
        const genresDone = document.getElementById('genresDone');


        // Clear / Done buttons
        genresClear.addEventListener('click', () => {
            document.querySelectorAll('#genreMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateGenreButtonText();
            applyFilters(); //kanei apply ta filters amesws
        });

        genresDone.addEventListener('click', () => {
            updateGenreButtonText();
            genreMulti.classList.remove('open');
            applyFilters(); //kanei apply ta filters amesws
        });

        document.querySelectorAll('#genreMenu input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', () => {
                updateGenreButtonText();

            });
        });

        // initial
        updateGenreButtonText();



        // Î’Î¿Î·Î¸Î·Ï„Î¹ÎºÎ® ÏƒÏ…Î½Î¬ÏÏ„Î·ÏƒÎ· Î³Î¹Î± Î¼ÎµÏ„Î±Ï„ÏÎ¿Ï€Î® Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±Ï‚ ÏƒÎµ timestamp 
        function dateOnlyTs(d) {
            const x = new Date(d);
            if (isNaN(x.getTime())) return null;
            return new Date(x.getFullYear(), x.getMonth(), x.getDate()).getTime();
        }

        async function fetchPublicEvents() {
            // EXPECTED endpoint: GET /user/public_events
            // returns array of events with at least:
            // { id, title, start, end?, city?, genre?, venue?, description?, price? }
            const res = await fetch(`${API_BASE}/public_events`);
            allPublicEvents = await res.json();
            applyFilters();
        }

        function applyFilters() {
            if (!calendar) return; // an den exei arxikopoihthei akoma
            const genre = getSelectedGenres(); //array
            const city = normalize(document.getElementById('cityInput').value);
            const fromVal = document.getElementById('dateFrom').value;
            const toVal = document.getElementById('dateTo').value;
            const maxPrice = document.getElementById('maxPrice').value ? Number(document.getElementById('maxPrice').value) : Infinity;
            const q = normalize(document.getElementById('textSearch').value);

            const fromTs = fromVal ? dateOnlyTs(fromVal) : null;
            const toTs = toVal ? dateOnlyTs(toVal) : null;

            const filtered = allPublicEvents.filter(ev => {
                // genre (Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹)
                if (genre.length) {
                    const g = normalize(ev.genre);
                    if (!genre.includes(g)) return false;
                }

                // city Greece-only
                if (city) {
                    const c = normalize(ev.city);
                    if (!c.includes(city)) return false;
                }

                // date range: compare start
                const evTs = dateOnlyTs(ev.start);
                if (fromTs && evTs !== null && evTs < fromTs) return false;
                if (toTs && evTs !== null && evTs > toTs) return false;

                // price
                const price = Number(ev.price ?? 0);
                if (price > maxPrice) return false;

                // free text
                if (q) {
                    const hay = `${ev.title ?? ''} ${ev.venue ?? ''} ${ev.description ?? ''} ${ev.city ?? ''}`.toLowerCase();
                    if (!hay.includes(q)) return false;
                }

                return true;
            });

            currentFilteredEvents = filtered; // apothikefsi twn filtered events
            const sorted = sortEvents(filtered);

            calendar.removeAllEvents();
            sorted.forEach(ev => {
                calendar.addEvent({
                    id: ev.id,
                    title: ev.title,
                    start: ev.start,
                    end: ev.end,
                    extendedProps: ev
                });
            });
            currentFilteredEvents = sorted;
            renderResultsList(sorted);
        }

        /*arxikopiisi tou calendar*/
        document.addEventListener('DOMContentLoaded', function () {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek'
                },
                // USER: read-only
                selectable: false,
                editable: false,
                eventStartEditable: false,
                eventDurationEditable: false,

                eventClick: function (info) {
                    const ev = info.event.extendedProps;
                    const lines = [
                        `Title: ${info.event.title}`,
                        `When: ${new Date(info.event.start).toLocaleString()}`,
                        ev.city ? `City: ${ev.city}` : null,
                        ev.venue ? `Venue: ${ev.venue}` : null,
                        ev.genre ? `Genre: ${ev.genre}` : null,
                        (ev.price != null) ? `Price: â‚¬${ev.price}` : null,
                        ev.description ? `Description: ${ev.description}` : null,
                    ].filter(Boolean);
                    alert(lines.join('\n'));
                }
            });
            calendar.render();
            fetchPublicEvents();
            loadBands();
        });

        document.getElementById('applyBtn').addEventListener('click', applyFilters);
        document.getElementById('clearBtn').addEventListener('click', () => {
            document.querySelectorAll('#genreMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateGenreButtonText();
            document.getElementById('cityInput').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            document.getElementById('maxPrice').value = '';
            document.getElementById('textSearch').value = '';
            applyFilters();
        });

        ['cityInput', 'dateFrom', 'dateTo', 'maxPrice', 'textSearch']
            .forEach(id => document.getElementById(id).addEventListener('input', applyFilters));

        //footer toggle
        const footer = document.getElementById('siteFooter');
        const footerToggle = document.getElementById('footerToggle');

        footerToggle.addEventListener('click', () => {
            const open = footer.classList.toggle('open');
            footerToggle.setAttribute('aria-expanded', open ? 'true' : 'false');

            // Î±Î½ Î±Î½Î¿Î¯Î¾ÎµÎ¹ more padding
            document.body.style.paddingBottom = open ? '220px' : '44px';
        });

        // Music Assistant drawer
        const musicFab = document.getElementById('musicFab');
        const musicDrawer = document.getElementById('musicDrawer');
        const musicClose = document.getElementById('musicClose');
        const musicOverlay = document.getElementById('musicOverlay');

        function openMusic() {
            musicDrawer.classList.add('open');
            musicOverlay.classList.add('open');
        }
        function closeMusic() {
            musicDrawer.classList.remove('open');
            musicOverlay.classList.remove('open');
        }

        musicFab.addEventListener('click', openMusic);
        musicClose.addEventListener('click', closeMusic);
        musicOverlay.addEventListener('click', closeMusic);

        // suggestions
        document.querySelectorAll('.sug').forEach(b => {
            b.addEventListener('click', () => {
                document.getElementById('musicText').value = b.dataset.q;
                sendMusic();
            });
        });

        function addMsg(text, who) {
            const box = document.getElementById('musicMsgs');
            const div = document.createElement('div');
            div.className = `msg ${who}`;
            div.textContent = text;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        async function sendMusic() {
            const input = document.getElementById('musicText');
            const q = input.value.trim();
            if (!q) return;

            addMsg(q, 'user');
            input.value = '';

            // TODO: ÎµÎ´Ï Î¸Î± ÎºÎ±Î»Î­ÏƒÎµÎ¹Ï‚ backend endpoint /music/ask
            // const res = await fetch('/music/ask', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({question:q})});
            // const data = await res.json();
            // addMsg(data.answer, 'bot');

            // Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒ:
            addMsg("Î‘Ï€Î¬Î½Ï„Î·ÏƒÎ· Î±Ï€ÏŒ LLM Î¸Î± ÎµÎ¼Ï†Î±Î½Î¹ÏƒÏ„ÎµÎ¯ ÎµÎ´Ï (ÏŒÏ„Î±Î½ ÏƒÏ…Î½Î´Î­ÏƒÎ¿Ï…Î¼Îµ Ï„Î¿ endpoint).", 'bot');
        }

        document.getElementById('musicSend').addEventListener('click', sendMusic);
        document.getElementById('musicText').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') sendMusic();
        });

        // get selected genres from band genre multi-select
        function getBandGenres() {
            return Array.from(document.querySelectorAll('#bandGenreMenu input[type="checkbox"]:checked'))
                .map(cb => cb.value.trim().toLowerCase());
        }
        // update band genre button text
        function updateBandGenreBtnText() {
            const selected = getBandGenres();
            const textEl = document.getElementById('bandGenreBtnText');

            if (!selected.length) textEl.textContent = 'ÎŒÎ»Î± Ï„Î± ÎµÎ¯Î´Î·';
            else if (selected.length <= 2) textEl.textContent = selected.join(', ');
            else textEl.textContent = `${selected.length} selected`;
        }
        // function that builds the query string for band filters
        function buildBandQuery() {
            const city = normalize(document.getElementById('bandCity').value);
            const yearFrom = normalize(document.getElementById('bandYearFrom').value);
            const yearTo = normalize(document.getElementById('bandYearTo').value);
            const genres = getBandGenres();

            const p = new URLSearchParams();
            if (city) p.set('city', city);
            if (yearFrom) p.set('year_from', yearFrom);
            if (yearTo) p.set('year_to', yearTo);
            if (genres.length) p.set('genres', genres.join(','));
            return p.toString();
        }
        async function loadBands() {
            const qs = buildBandQuery();
            const res = await fetch(`${API_BASE}/bands?${qs}`);
            const bands = await res.json();
            renderBands(bands);//gia cards 
        }

        // --- dropdown open/close Î³Î¹Î± band genres ---
        const bandGenreMulti = document.getElementById('bandGenreMulti');
        document.getElementById('bandGenreBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            bandGenreMulti.classList.toggle('open');
        });
        document.addEventListener('click', () => bandGenreMulti.classList.remove('open'));
        // clear / done buttons
        document.getElementById('bandGenresClear').addEventListener('click', () => {
            document.querySelectorAll('#bandGenreMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateBandGenreBtnText();
            loadBands(); // fortonei amesws
        });
        document.getElementById('bandGenresDone').addEventListener('click', () => {
            updateBandGenreBtnText();
            bandGenreMulti.classList.remove('open');
            loadBands(); // fortonei amesws
        });
        // initial
        document.getElementById('bandApply').addEventListener('click', loadBands);
        document.getElementById('bandClear').addEventListener('click', () => {
            document.getElementById('bandCity').value = '';
            document.getElementById('bandYearFrom').value = '';
            document.getElementById('bandYearTo').value = '';
            document.querySelectorAll('#bandGenreMenu input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateBandGenreBtnText();
            loadBands();
        });
        updateBandGenreBtnText();


        //code for map and pins 

        // 1) Create map (OSM)
        const map = new ol.Map({
            target: 'map',
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM()
                })
            ],
            view: new ol.View({
                center: ol.proj.fromLonLat([21.7346, 38.2466]), // Greece-ish (lon, lat)
                zoom: 6
            })
        });

        // 2) Markers layer
        const vectorSource = new ol.source.Vector();
        const markersLayer = new ol.layer.Vector({ source: vectorSource });
        map.addLayer(markersLayer);

        // Marker style (pin-ish circle)
        const markerStyle = new ol.style.Style({
            image: new ol.style.Circle({
                radius: 7,
                fill: new ol.style.Fill({ color: '#e11d48' }),
                stroke: new ol.style.Stroke({ color: '#ffffff', width: 2 })
            })
        });

        async function loadFutureEvents() {
            // REST endpoint Ï€Î¿Ï… ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÎ¹ future events Î¼Îµ lat/lng
            // Ï€.Ï‡. GET /public_events/map
            const res = await fetch('http://localhost:3000/public_events/map');
            const events = await res.json();

            vectorSource.clear();

            events.forEach(ev => {
                if (ev.lat == null || ev.lng == null) return;

                const feature = new ol.Feature({
                    geometry: new ol.geom.Point(ol.proj.fromLonLat([ev.lng, ev.lat])),
                    ev: ev
                });

                feature.setStyle(markerStyle);
                vectorSource.addFeature(feature);
            });

            // zoom ÏƒÎµ ÏŒÎ»Î± Ï„Î± pins Î±Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½
            if (vectorSource.getFeatures().length) {
                const extent = vectorSource.getExtent();
                map.getView().fit(extent, { padding: [20, 20, 20, 20], maxZoom: 14 });
            }
        }

        // 3) Simple click popup using browser alert (ÎµÏÎºÎ¿Î»Î¿)
        map.on('singleclick', function (evt) {
            map.forEachFeatureAtPixel(evt.pixel, function (feature) {
                const ev = feature.get('ev');
                const when = new Date(ev.start).toLocaleString();
                alert(`${ev.title}\n${when}\n${ev.city || ''} â€¢ ${ev.genre || ''}`);
            });
        });
        //1

        loadFutureEvents();

        function renderResultsList(events) {
            const box = document.getElementById('resultsList');

            if (!events.length) {
                box.innerHTML = '<p>No matching events.</p>';
                return;
            }

            box.innerHTML = events
                .slice()
                .sort((a, b) => new Date(a.start) - new Date(b.start))
                .map(ev => {
                    const when = new Date(ev.start).toLocaleString('el-GR');
                    const city = ev.city ? ev.city : '-';
                    const price = (ev.price != null) ? Number(ev.price) : 0;
                    const venue = ev.venue ? ev.venue : '';
                    const desc = ev.description ? ev.description : '';

                    const safeTitle = (ev.title ?? '')
                        .replaceAll('<', '&lt;')
                        .replaceAll('>', '&gt;');

                    return `
                    <div class="event-card">
                    <h3>${safeTitle}</h3>
                    <p><strong>Date:</strong> ${when}</p>
                    <p><strong>City:</strong> ${city}</p>
                    ${venue ? `<p><strong>Venue:</strong> ${venue}</p>` : ''}
                    <p><strong>Ticket:</strong> â‚¬${price}</p>
                    ${desc ? `<p><i>${desc}</i></p>` : ''}

                    <div style="margin-top:10px;">
                        <button class="btn btn-ticket tickets-btn" data-id="${ev.id}" type="button">
                        Tickets
                        </button>
                    </div>
                    </div>
                `;
                })
                .join('');
        }


        //code for ticket parathiro
        const ticketModal = document.getElementById('ticketModal');
        const ticketOverlay = document.getElementById('ticketOverlay');
        const ticketClose = document.getElementById('ticketClose');
        const ticketQty = document.getElementById('ticketQty');
        const ticketTitle = document.getElementById('ticketTitle');
        const ticketMeta = document.getElementById('ticketMeta');
        const ticketUnit = document.getElementById('ticketUnit');
        const ticketTotal = document.getElementById('ticketTotal');
        const ticketPayBtn = document.getElementById('ticketPayBtn');
        const ticketMsg = document.getElementById('ticketMsg');

        let activeTicketEvent = null;

        function openTickets(ev) {
            activeTicketEvent = ev;

            const when = new Date(ev.start).toLocaleString('el-GR');
            ticketTitle.textContent = ev.title || 'Tickets';
            ticketMeta.textContent = `${when} â€¢ ${ev.city || ''} ${ev.venue ? 'â€¢ ' + ev.venue : ''}`;

            const unit = Number(ev.price ?? 0);
            ticketUnit.textContent = unit.toFixed(2);

            ticketQty.value = 1;
            ticketMsg.textContent = '';
            updateTicketTotal();

            ticketOverlay.classList.add('open');
            ticketModal.classList.add('open');
            ticketModal.setAttribute('aria-hidden', 'false');
        }

        function closeTickets() {
            ticketOverlay.classList.remove('open');
            ticketModal.classList.remove('open');
            ticketModal.setAttribute('aria-hidden', 'true');
            activeTicketEvent = null;
        }

        function updateTicketTotal() {
            const unit = Number(activeTicketEvent?.price ?? 0);
            const qty = Math.max(1, Number(ticketQty.value || 1));
            ticketTotal.textContent = (unit * qty).toFixed(2);
        }

        ticketQty.addEventListener('input', updateTicketTotal);
        ticketClose.addEventListener('click', closeTickets);
        ticketOverlay.addEventListener('click', closeTickets);

        // Demo pay Ï‡Ï‰ÏÎ¯Ï‚ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÎ® Ï€Î»Î·ÏÏ‰Î¼Î®
        ticketPayBtn.addEventListener('click', async () => {
            if (!activeTicketEvent) return;

            const qty = Math.max(1, Number(ticketQty.value || 1));
            const total = Number(ticketTotal.textContent);

            // TODO: Ï€Î»Î·ÏÏ‰Î¼Î® 
            // Ï€ÏÎ¿Ï‚ Ï„Î¿ Ï€Î±ÏÏŒÎ½ demo:
            ticketMsg.textContent = `âœ… Demo: Î˜Î± Ï‡ÏÎµÏ‰Î¸ÎµÎ¯Ï‚ â‚¬${total.toFixed(2)} Î³Î¹Î± ${qty} ÎµÎ¹ÏƒÎ¹Ï„Î®ÏÎ¹Î±. (Payment endpoint Î­ÏÏ‡ÎµÏ„Î±Î¹)`;
        });
        //click handler for tickets buttons in results list
        document.getElementById('resultsList').addEventListener('click', (e) => {
            const btn = e.target.closest('.tickets-btn');
            if (!btn) return;

            const id = Number(btn.dataset.id);
            const ev = currentFilteredEvents.find(x => Number(x.id) === id);


            if (ev) openTickets(ev);
        });

        //gia tickets 
        document.getElementById('btnMyTickets')?.addEventListener('click', () =>
            location.href = 'html/users/my_tickets.html'
        );


        // LOGOUT LOGIC
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                try {
                    await fetch('http://localhost:3000/logout', { method: 'POST' });
                    alert("Logged out");
                    window.location.href = "http://localhost:3000/index2.html"; // Redirect to guest home
                } catch (err) {
                    console.error(err);
                    alert("Logout failed");
                }
            });
        }
    </script>
</body>

</html>